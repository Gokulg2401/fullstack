git branch: 'main', credentialsId: '28b28bd1-7fe5-4556-bf9a-484cfc6d1e05', url: 'https://github.com/Gokulg2401/Reactproject.git'


pipeline {
    agent any

    environment {
        // Customize as needed
        PORT = '8080'
        REACT_APP_API_URL = "http://localhost:3000/api" 
    }

    stages {
        stage('Checkout') {
            steps {
                // Pull code from GitHub using stored credentials
                git branch: 'main', credentialsId: 'github-pat', url: 'https://github.com/Gokulg2401/Reactproject'
            }
        }

        stage('Build Frontend') {
            steps {
                dir('src/comp') {  // Update with your frontend path
                    sh '''
                    npm install
                    npm run build
                    '''
                }
            }
        }

        stage('Build Backend and Copy Frontend') {
            steps {
                // Copy React build to backend static resources folder
                sh 'cp -r src/comp* demo/src/main/java/com/gklproject/demo'

                dir('demo/src/main/java/com/gklproject/demo') {  // Update with your backend directory
                    sh './mvnw clean package'
                }
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                # Stop any existing Spring Boot app
                pkill -f "java -jar" || true

                # Find the jar file built and run it in background
                JAR_FILE=$(ls target/*.jar | head -n 1)
                nohup java -jar "$JAR_FILE" > app.log 2>&1 &
                '''
            }
        }
    }

    post {
        success {
            echo 'Build and deployment completed successfully.'
            echo "Access your app at: http://${env.JENKINS_SERVER_IP ?: '<your-aws-server-ip>'}:${env.PORT}"
        }
        failure {
            echo 'Build or deployment failed. Check logs for details.'
        }
    }
}
